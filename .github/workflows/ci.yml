name: CI

on:
  - pull_request

jobs:
  ci:
    runs-on: macos-latest
    steps:
      - name: brew pull       
        run: |
          brew update-reset "$(brew --repository)"

          HOMEBREW_INSTALL_BUNDLER_GEMS_FIRST=1 brew config

          brew tap "${GITHUB_REPOSITORY}"

          # Get latest version of `brew cask ci` command.
          if [ "${GITHUB_REPOSITORY}" != Homebrew/homebrew-cask ]; then
            brew update-reset "$(brew --repository homebrew/cask)"
          fi

          brew update-reset "$(brew --repository "${GITHUB_REPOSITORY}")"

          # Install `hub`
          curl -fsSL https://github.com/github/hub/raw/master/script/get | bash -s 2.14.1
          
          cd "$(brew --repository "${GITHUB_REPOSITORY}")"
          hub pr checkout ${PR_NUMBER}
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ github.token }}
          HOMEBREW_COLOR: 1
          HOMEBREW_DEVELOPER: 1
      - name: brew cask ci
        run: |
          cd "$(brew --repository "${GITHUB_REPOSITORY}")"
          unset HOMEBREW_CASK_OPTS
          brew cask ci
        env:
          CI: true
          HOMEBREW_COLOR: 1
          HOMEBREW_DEVELOPER: 1
