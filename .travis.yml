language: objective-c

# todo
#
# test with Ruby 1.9, but allow failure
# test with Ruby 2.1, but allow failure
#

# "Current" is currently a duplicate of either 1.8 or 2.0, depending on OS version
env:
  matrix:
    - CASK_TEST_RUBY_VERSION="1.8"
    - CASK_TEST_RUBY_VERSION="1.9"
    - CASK_TEST_RUBY_VERSION="2.0"
    - CASK_TEST_RUBY_VERSION="2.1"
    - CASK_TEST_RUBY_VERSION="Current"

# permit "Current" to fail without affecting our badge
matrix:
  allow_failures:
    - env: CASK_TEST_RUBY_VERSION="Current"
    - env: CASK_TEST_RUBY_VERSION="1.9"
    - env: CASK_TEST_RUBY_VERSION="2.1"

# before_install steps
# * turn off RVM
# * set PATH according to env matrix
# * update Homebrew
# * informational feedback
before_install:
  - echo ls_rvm_dir; ls /Users/travis/.rvm/rubies
  - rvm use system
  - test -e "/System/Library/Frameworks/Ruby.framework/Versions/${CASK_TEST_RUBY_VERSION}/usr/bin" && export CASK_RUBY_BIN_DIR="/System/Library/Frameworks/Ruby.framework/Versions/${CASK_TEST_RUBY_VERSION}/usr/bin" || export CASK_RUBY_BIN_DIR="/Users/travis/.rvm/rubies/${CASK_TEST_RUBY_VERSION}/bin"
  - export PATH="${CASK_RUBY_BIN_DIR}/usr/bin":"$PATH"
  - brew update
  - printenv PATH
  - /usr/bin/which ruby
  - ruby --version
  - /usr/bin/which rake
  - rake --version
  - echo ls_ruby_bindir; ls "${CASK_RUBY_BIN_DIR}"

# install steps
# * brew Formulae without which some tests will be skipped
# * bundler gem
# * Ruby gems required for brew-cask
install:
  - brew install cabextract
  - brew install unar
  - echo gem_install_bundler; sudo "${CASK_RUBY_BIN_DIR}/gem" install bundler --bindir="${CASK_RUBY_BIN_DIR}"
  - echo bundle; sudo "${CASK_RUBY_BIN_DIR}/bundle" --system

# informational feedback
before_script:
  - echo ls_rvm_dir; ls /Users/travis/.rvm/rubies
  - printenv PATH
  - /usr/bin/which ruby
  - ruby --version
  - /usr/bin/which bundle
  - bundle --version
  - /usr/bin/which rake
  - rake --version
  - echo ls_ruby_bindir; ls "${CASK_RUBY_BIN_DIR}"

# the test itself
# path-quoting is different here due to YAML constraints
script:
  - /"${CASK_RUBY_BIN_DIR}"/bundle exec "${CASK_RUBY_BIN_DIR}/rake" test

notifications:
  irc:
    channels:
      - "chat.freenode.net#homebrew-cask"
    template:
      - "%{build_number}: %{branch}@%{commit} %{author} -> %{message} %{build_url}"
    use_notice: true
    skip_join: true
  email: false
