jobs:
- job: macOS
  pool:
    vmImage: macOS-10.13
  steps:
    - bash: |
        # Force strict error checking.
        set -o errexit
        set -o pipefail
        set -o nounset
        # set env
        export HOMEBREW_COLOR=1
        export HOMEBREW_DEVELOPER=1
        export HOMEBREW_NO_AUTO_UPDATE=1
        export HOMEBREW_AZURE_REPOSITORY_URI="$(Build.Repository.Uri)"
        export HOMEBREW_AZURE_PULLREQUESTNUMBER ="$(System.PullRequest.PullRequestNumber)"
        export HOMEBREW_AZURE_TARGETBRANCH="$(System.PullRequest.TargetBranch)"
        export HOMEBREW_AZURE_SOURCEVERSION="$(Build.SourceVersion)"
        # Using brew update-reset and restricting directories is quicker/more robust than brew update
        brew update-reset "$(brew --repository)"
        # TEMPORARY: Overwrite brewcask-ci.rb with my version since the changes are not merged yet
        cp -f "$(Build.SourcesDirectory)/cmd/brewcask-ci.rb" "$(brew --repository)/Library/Taps/homebrew/homebrew-cask/cmd/"
        # Mirror the repo as a tap.
        TAP_DIR="$(brew --repository)/Library/Taps/$(Build.Repository.Name)"
        echo "DEBUG: TAP_DIR is ${TAP_DIR}"
        mkdir -p "${TAP_DIR}"
        rsync --archive --compress --delete "$(Build.SourcesDirectory)/" "${TAP_DIR}/"
        cd "${TAP_DIR}"
        brew cask ci
      displayName: Run brew cask ci
